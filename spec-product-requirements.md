# DevForge AI 聊天助手 — 产品需求文档（可供性驱动）

> **文档版本**: v1.0
> **创建日期**: 2026-02-18
> **关联里程碑**: M5 — 交互式技术问答
> **状态**: 草案

---

## 1. 产品概述

### 1.1 需求背景

DevForge 当前已集成 AI 博客摘要和项目推荐功能，但访客与网站的交互仍是单向的——访客只能被动浏览内容。增加 AI 聊天助手，让访客能够以自然语言与网站"对话"，主动获取关于站主技术背景、项目细节、博客内容的信息，将被动浏览转化为主动探索。

### 1.2 核心价值

- 为招聘方/HR 提供即时问答入口，快速了解候选人技术能力
- 为技术同行提供交互式的项目和博客内容探索方式
- 展示站主的 AI 工程能力（本身就是一个技术作品）

### 1.3 产品定位

AI 聊天助手是 DevForge 网站的**嵌入式对话组件**，定位为"了解 Yeebin 的智能向导"。它不是通用聊天机器人，而是一个**以站主个人信息为知识边界**的专属助手。

---

## 2. 智能体与环境分析

### 2.1 智能体（Agents）

| 智能体 | 感知能力 | 行动能力 | 目标 |
|--------|---------|---------|------|
| 匿名访客 | 视觉感知（UI 元素）、文本理解 | 点击、输入文本、滚动 | 快速了解站主技术背景 |
| 已识别访客 | 同上 | 同上 + 可关联历史对话 | 深入了解特定项目/技术细节 |
| AI 助手 | 接收用户消息、检索站内数据 | 生成文本回复、引用站内内容 | 准确回答关于站主的问题 |
| 管理员 | 后台数据面板 | 查看对话记录、配置系统提示词 | 监控对话质量、优化助手表现 |

### 2.2 环境约束（来自 real.md）

| 约束 | 影响 | 应对策略 |
|------|------|---------|
| Vercel Serverless 10s 超时 | AI 生成可能超时 | 使用 Streaming（Edge Runtime） |
| API 密钥仅限服务端 | 前端不能直接调用 AI | 通过 Route Handler 代理 |
| 每日 API 调用上限 50 次 | 聊天消耗更快 | 聊天独立计数，设 30 次/日上限 |
| 数据库连接数有限（~20） | 高并发时连接耗尽 | 复用现有连接池，对话存储轻量化 |

---

## 3. 可供性定义

### 3.1 核心可供性

#### AF-CHAT-01: 对话发起可供性

**环境属性**: 页面右下角的浮动聊天按钮（Floating Action Button）

| 维度 | 描述 |
|------|------|
| 行动可能性 | 访客可以点击按钮打开聊天面板 |
| 信号设计 | 圆形按钮 + 消息气泡图标 + 微弱脉冲动画，暗示"这里可以对话" |
| 感知通道 | 视觉（图标形状、位置惯例）；语义（aria-label="与 AI 助手对话"） |
| 约束 | 按钮始终可见（fixed 定位），不遮挡主要内容 |
| 状态变化 | 未打开 → 悬停高亮 → 点击展开面板 |

#### AF-CHAT-02: 消息输入可供性

**环境属性**: 聊天面板底部的文本输入区域

| 维度 | 描述 |
|------|------|
| 行动可能性 | 访客可以输入自然语言问题并发送 |
| 信号设计 | 输入框 + placeholder 提示（如"问我关于 Yeebin 的任何事..."）+ 发送按钮 |
| 感知通道 | 视觉（输入框形状）；语义（input type、aria 属性） |
| 约束 | 单条消息最大 500 字符；空消息不可发送（按钮禁用态） |
| 快捷操作 | Enter 发送，Shift+Enter 换行 |

#### AF-CHAT-03: 流式回复感知可供性

**环境属性**: 聊天面板中的 AI 回复消息区域

| 维度 | 描述 |
|------|------|
| 行动可能性 | 访客可以实时观看 AI 逐字生成回复 |
| 信号设计 | 打字机效果 + 闪烁光标 + "AI 正在思考..." 加载指示器 |
| 感知通道 | 视觉（文字逐步出现）；时间感知（流式传输减少等待焦虑） |
| 约束 | 生成过程中输入框保持可用但发送按钮禁用，防止并发请求 |

#### AF-CHAT-04: 上下文引用可供性

**环境属性**: AI 回复中嵌入的站内内容链接

| 维度 | 描述 |
|------|------|
| 行动可能性 | 访客可以点击引用链接跳转到相关项目/博客页面 |
| 信号设计 | 行内链接样式（下划线 + 主题色）+ 引用卡片（标题 + 简介） |
| 感知通道 | 视觉（链接样式惯例）；语义（href 指向站内路由） |
| 约束 | 仅引用已发布（published=true）的内容 |

#### AF-CHAT-05: 预设问题可供性

**环境属性**: 聊天面板初始状态下的快捷问题按钮

| 维度 | 描述 |
|------|------|
| 行动可能性 | 访客可以点击预设问题快速发起对话，无需手动输入 |
| 信号设计 | 胶囊形按钮组，如"你擅长什么技术？""介绍一下你的项目""你的工作经历？" |
| 感知通道 | 视觉（按钮形状暗示可点击）；文本内容暗示对话主题 |
| 约束 | 仅在对话为空时显示；点击后转化为用户消息进入正常对话流 |

### 3.2 管理端可供性

#### AF-CHAT-ADMIN-01: 对话记录查看可供性

**环境属性**: 后台管理面板中的对话记录列表

| 维度 | 描述 |
|------|------|
| 行动可能性 | 管理员可以浏览、搜索、查看完整对话记录 |
| 信号设计 | 表格列表 + 时间排序 + 搜索框 |
| 约束 | 只读，管理员不能修改历史对话内容 |

#### AF-CHAT-ADMIN-02: 系统提示词配置可供性

**环境属性**: 后台设置页面中的系统提示词编辑区

| 维度 | 描述 |
|------|------|
| 行动可能性 | 管理员可以编辑 AI 助手的系统提示词（人设、知识范围、回复风格） |
| 信号设计 | 多行文本编辑器 + 保存按钮 + 预览效果 |
| 约束 | 提示词长度上限 2000 字符 |

---

## 4. 可供性序列（用户旅程）

### 4.1 首次对话流程

```
[访客浏览页面]
    │
    ▼
AF-CHAT-01: 感知浮动按钮 → 点击打开面板
    │
    ▼
AF-CHAT-05: 感知预设问题 → 点击"你擅长什么技术？"
    │
    ▼
AF-CHAT-03: 观看 AI 流式回复，了解站主技术栈
    │
    ▼
AF-CHAT-04: 感知回复中的项目链接 → 点击跳转到项目详情页
    │
    ▼
AF-CHAT-02: 返回聊天，输入追问"这个项目用了什么架构？"
    │
    ▼
AF-CHAT-03: 获得带有博客引用的详细回答
```

### 4.2 状态机

```
┌─────────┐    点击按钮    ┌─────────┐
│  关闭态  │──────────────→│  空对话  │
│ (按钮)   │←──────────────│ (预设题) │
└─────────┘    点击关闭    └────┬────┘
                                │ 发送消息/点击预设
                                ▼
                          ┌─────────┐
                          │ AI生成中 │
                          │(流式输出)│
                          └────┬────┘
                               │ 生成完成
                               ▼
                          ┌─────────┐
                          │ 对话进行 │←─┐
                          │(可继续问)│──┘ 发送新消息
                          └────┬────┘
                               │ 达到上限/关闭
                               ▼
                          ┌─────────┐
                          │ 对话结束 │
                          └─────────┘
```

---

## 5. 技术规约

### 5.1 新增 API 路由

| 路由 | 方法 | 功能 | Runtime |
|------|------|------|---------|
| `/api/ai/chat` | POST | 接收消息，返回流式 AI 回复 | Edge |

**请求体**:
```typescript
{
  messages: Array<{ role: "user" | "assistant"; content: string }>;
  sessionId?: string;  // 可选，用于关联对话上下文
}
```

**响应**: `ReadableStream`（Vercel AI SDK 的 `streamText` 格式）

### 5.2 数据模型扩展

新增 `chat_sessions` 表：

```typescript
export const chatSessions = pgTable("chat_sessions", {
  id: varchar("id", { length: 64 }).primaryKey(),  // nanoid
  visitorId: varchar("visitor_id", { length: 128 }),
  messages: text("messages").notNull(),  // JSON 序列化的消息数组
  messageCount: integer("message_count").default(0),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

新增 `chat_config` 表：

```typescript
export const chatConfig = pgTable("chat_config", {
  id: serial("id").primaryKey(),
  systemPrompt: text("system_prompt").notNull(),
  presetQuestions: text("preset_questions").notNull(),  // JSON 数组
  dailyLimit: integer("daily_limit").default(30),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### 5.3 系统提示词设计

AI 助手的默认系统提示词应包含：

```
你是 DevForge 的 AI 助手，专门帮助访客了解 Yeebin Huang 的技术背景。

你的知识范围：
- Yeebin 的项目作品（从数据库 projects 表获取）
- Yeebin 的技术博客（从数据库 posts 表获取）
- Yeebin 的技能栈（从数据库 skills 表获取）
- Yeebin 的教育和工作经历（从数据库 experiences 表获取）

回复规则：
- 使用中文回复
- 回复简洁友好，控制在 300 字以内
- 引用具体项目或文章时，使用 [标题](/路径) 格式提供链接
- 不回答与 Yeebin 无关的问题，礼貌引导回正题
- 不编造不存在的信息
```

### 5.4 前端组件结构

```
src/components/chat/
├── chat-button.tsx        # 浮动按钮（AF-CHAT-01）
├── chat-panel.tsx         # 聊天面板容器
├── chat-messages.tsx      # 消息列表（AF-CHAT-03）
├── chat-input.tsx         # 输入区域（AF-CHAT-02）
├── chat-preset.tsx        # 预设问题（AF-CHAT-05）
└── chat-reference.tsx     # 引用卡片（AF-CHAT-04）
```

### 5.5 关键技术决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 运行时 | Edge Runtime | 规避 10s 超时限制，支持长时间流式传输 |
| 对话存储 | 服务端 + sessionStorage | 服务端持久化用于管理员查看，sessionStorage 用于页面刷新恢复 |
| 上下文注入 | 每次请求时查询数据库拼接到 system prompt | 保证信息实时性，避免缓存过期问题 |
| 消息历史 | 最近 10 轮对话作为上下文 | 平衡上下文质量与 token 消耗 |
| Markdown 渲染 | 复用现有 post-content 的渲染逻辑 | 支持代码块、链接等富文本格式 |

---

## 6. 可供性信号设计

### 6.1 视觉信号

| 元素 | 设计 | 可供性暗示 |
|------|------|-----------|
| 浮动按钮 | 56px 圆形，主题色背景，`MessageCircle` 图标 | "这里可以对话" |
| 聊天面板 | 384px 宽，右下角弹出，圆角卡片 | "这是一个独立的对话空间" |
| 输入框 | 底部固定，左侧输入区 + 右侧发送按钮 | "在这里输入你的问题" |
| AI 消息 | 左对齐，带 AI 头像，浅色背景 | "这是 AI 的回复" |
| 用户消息 | 右对齐，主题色背景 | "这是你发送的消息" |
| 预设问题 | 胶囊形按钮，居中排列 | "点击即可快速提问" |

### 6.2 交互反馈

| 交互 | 反馈 |
|------|------|
| 悬停浮动按钮 | 放大 + 阴影加深 |
| 发送消息 | 消息立即出现在对话区 + 输入框清空 |
| AI 生成中 | 显示"思考中..."骨架 + 文字逐字出现 |
| 达到每日上限 | 输入框禁用 + 提示"今日对话次数已用完，明天再来吧" |
| 网络错误 | 消息气泡显示错误状态 + 重试按钮 |

---

## 7. 约束与边界

### 7.1 功能边界

- **不做**: 多轮复杂推理、代码执行、文件上传、语音输入
- **不做**: 用户注册/登录才能使用（匿名即可对话）
- **不做**: 对话导出、分享功能（v1 不需要）
- **做**: 纯文本对话、站内内容引用、预设快捷问题、流式回复

### 7.2 性能约束

| 指标 | 目标值 |
|------|--------|
| 首字节响应时间（TTFB） | < 1s |
| 聊天面板打开动画 | < 300ms |
| 浮动按钮加载 | 不阻塞页面首屏渲染（动态导入） |
| 单次对话 token 上限 | 1024 tokens（输出） |
| 每日对话次数上限 | 30 次/IP |

### 7.3 安全约束

| 约束 | 措施 |
|------|------|
| Prompt 注入防护 | 系统提示词中明确角色边界，拒绝角色扮演请求 |
| 敏感信息保护 | 系统提示词禁止输出手机号、身份证等 PII |
| 速率限制 | 复用现有 `rate-limit.ts`，endpoint 设为 "chat" |
| 输入清洗 | 前端限制 500 字符，后端 zod 校验 |

---

## 8. 认知模型扩展（cog.md 增量）

需要在 cog.md 中新增以下实体：

```
- chat_session：聊天会话，访客与 AI 助手的一次对话
  - active：进行中的会话
  - completed：已结束的会话（超过30分钟无活动自动关闭）
```

新增关系：
```
- visitor-chat_session：一对多（一个访客可发起多次聊天会话）
```

---

## 9. 验收标准

### 9.1 核心场景

1. **访客首次对话**: 访客点击浮动按钮 → 看到欢迎语和预设问题 → 点击预设问题 → 收到流式回复
2. **自由提问**: 访客输入"你做过哪些 AI 项目？" → AI 回复包含项目列表和链接 → 点击链接可跳转
3. **边界处理**: 访客问"今天天气怎么样？" → AI 礼貌拒绝并引导回技术话题
4. **速率限制**: 达到 30 次上限后 → 输入框禁用 → 显示友好提示
5. **管理员查看**: 管理员在后台可以看到对话记录列表和详情

### 9.2 非功能验收

- [ ] 聊天面板在移动端（375px）正常显示（全屏模式）
- [ ] 聊天面板在桌面端不遮挡主要内容
- [ ] 页面刷新后当前对话可恢复（sessionStorage）
- [ ] AI 回复支持 Markdown 渲染（代码块、链接、列表）
- [ ] 浮动按钮使用动态导入，不影响页面 LCP

---

## 10. 依赖与复用

### 10.1 复用现有基础设施

| 模块 | 路径 | 复用方式 |
|------|------|---------|
| AI Provider | `src/lib/ai/providers.ts` | 直接使用 `getModel()` |
| 流式生成 | `src/lib/ai/index.ts` | 使用 `streamAIText()` |
| 速率限制 | `src/lib/ai/rate-limit.ts` | 新增 endpoint="chat" |
| 缓存 | `src/lib/ai/cache.ts` | 可选：缓存常见问题的回答 |
| 数据库 | `src/lib/db/index.ts` | 复用连接池 |
| UI 组件 | `src/components/ui/*` | Button, Input, Card 等 |

### 10.2 新增依赖

| 依赖 | 用途 | 说明 |
|------|------|------|
| `nanoid` | 生成 session ID | 轻量级 ID 生成器 |
| `react-markdown` | 渲染 AI 回复中的 Markdown | 如项目中尚未使用 |

---

## 附录：可供性 → 传统需求映射

| 可供性 | 对应传统功能描述 |
|--------|----------------|
| AF-CHAT-01 对话发起 | 浮动聊天按钮组件 |
| AF-CHAT-02 消息输入 | 聊天输入框与发送功能 |
| AF-CHAT-03 流式回复 | AI 流式响应与打字机效果 |
| AF-CHAT-04 上下文引用 | 站内内容链接嵌入 |
| AF-CHAT-05 预设问题 | 快捷问题按钮组 |
| AF-CHAT-ADMIN-01 对话记录 | 后台对话管理页面 |
| AF-CHAT-ADMIN-02 提示词配置 | 后台 AI 配置页面 |
